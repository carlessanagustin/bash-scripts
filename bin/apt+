#!/bin/bash -eux

function __apt+_debian {
    cat <<EOF
# program : package [ : program-alias ]*
curl:curl
fd-find:fd-find
rg:ripgrep
g++:g++
gcc:gcc
libgmp-dev:libgmp-dev
make:cmake
libncurses-dev:libncurses-dev
xz-utils:xz-utils
realpath:coreutils
EOF
}

function __apt+_opensuse {
    cat <<EOF
# program : package [ : program-alias ]*
curl:curl
fd:fd
rg:ripgrep
g++:gcc-c++
gcc:gcc
libgmp-dev:libgmpxx4
make:cmake
libncurses-dev:ncurses-devel
xz-utils:xz
realpath:coreutils
EOF
}

function apt+ {
    if [[ "$1" == "install" ]] ;then
        shift
        local distro="$(lsb_release -si)"
        case "${distro}" in
            Debian)   distro=debian;;
            openSUSE) distro=opensuse;;
            *) echo "Unsupported distribution ${distro}" ; return 1 ;;
        esac

        for pkg in $@ ;do
            local program=$1
            local pkg=$(echo $1 | sed 's/+/\\+/g')
            local pkg=$(__apt+_${distro} | grep -E "^${pkg}:" | grep -E -v '(^[ \t]*#)|(^[ \t]*$)' | cut -d: -f2)
            if [[ ! -z "${pkg}" ]] ;then
                case "${distro}" in
                    debian)   which ${program} >/dev/null 2>&1 || dpkg-query -s ${pkg} >/dev/null 2>&1 || sudo apt    install -y ${pkg} ;;
                    opensuse) which ${program} >/dev/null 2>&1 || zypper se -ix ${pkg} >/dev/null 2>&1 || sudo zypper install -y ${pkg} ;;
                    *) echo "Unsupported distribution ${distro}" ; return 1;;
                esac
            else
                echo "Unable to find package for program: ${program}" ; return 1
            fi
            shift
        done
    fi
}

apt+ $@
